{% extends "base.html" %}
{% load i18n %}
{% block ss %}
    <link href="/static/css/wordwalls/wordwallsCreateTable.css" rel="stylesheet">
    <link href="/static/css/aerolith/bootstrap-datepicker.css" rel="stylesheet">
{% endblock %}
{% block title %}{% trans "Wordwalls - select list" %}{% endblock %}

{% block content %}
<script src="/static/lib/bootstrap/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
<!-- Add regression.js for trend line -->
<script src="https://cdn.jsdelivr.net/npm/regression@2.0.1/dist/regression.min.js"></script>
<script src="/static/lib/bootstrap-datepicker.js"></script>

<div class="container">

    <div class="row">

        <div class="col-md-6">

            <p>

                Lexicon:<br>
                <select class="form-control" id="lexicon">
                  <option value="24">NWL23</option>
                  <option value="25">CSW24</option>
                  <option value="23">FRA24</option>
                  <option value="17">Deutsch</option>
                  <option value="26">OSPS50</option>
                  <option value="10">FISE2</option>
                </select>

            </p>

            <p>

                Challenge:<br>
                <select class="form-control" id="challenge">
                  <option value="1">Today's 2's</option>
                  <option value="2">Today's 3's</option>
                  <option value="3">Today's 4's</option>
                  <option value="4">Today's 5's</option>
                  <option value="5">Today's 6's</option>
                  <option value="6">Today's 7's</option>
                  <option value="7">Today's 8's</option>
                  <option value="8">Today's 9's</option>
                  <option value="9">Today's 10's</option>
                  <option value="10">Today's 11's</option>
                  <option value="11">Today's 12's</option>
                  <option value="12">Today's 13's</option>
                  <option value="13">Today's 14's</option>
                  <option value="14">Today's 15's</option>
                  <option value="15">Week's Bingo Toughies</option>
                  <option value="16">Blank Bingos</option>
                  <option value="17">Bingo Marathon</option>
                  <option value="18">Common Words (short)</option>
                  <option value="19">Common Words (long)</option>
                  <option value="20">Word Builder (3-6)</option>
                  <option value="21">Word Builder (4-7)</option>
                  <option value="22">Word Builder (5-8)</option>
                </select>

            <p>

                Start Date:<br>
                <input data-provide="datepicker" id="start-date" class="form-control date-picker">

            </p>

            <p>

                End Date:<br>
                <input data-provide="datepicker" id="end-date" class="form-control date-picker">

            </p>

            </p>

            <button type="button" class="btn btn-primary" id="dropdown-button">Submit</button>

            </p>

    </div>



    <div class="col-md-6">

        <table class="table">
          <thead>
            <tr>
              <th></th>
              <th>Average</th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th scope="row">Time Remaining (seconds)</th>
              <td><span id="time"></span></td>
              <td><span id="time-low"></span></td>
              <td><span id="time-high"></span></td>
            </tr>
            <tr>
              <th scope="row">Score</th>
              <td><span id="scores"></span></td>
              <td><span id="scores-low"></span></td>
              <td><span id="scores-high"></span></td>
            </tr>
            <tr>
              <th scope="row">Combined Score</th>
              <td><span id="combined-scores"></span></td>
              <td><span id="combined-scores-low"></span></td>
              <td><span id="combined-scores-high"></span></td>
            </tr>
          </tbody>
        </table>

    </div>

</div>

<div id="chart-container" class="container mt-4">
    <canvas id="combinedChart" width="800" height="300"></canvas>
</div>

</p>

<img src="/static/img/aerolith/blue_spinner.gif" style="display: none; position: fixed; left: 600px; top: 100px;" class="ring-spinner">

<script>

$('.date-picker').datepicker({
    format: 'yyyy-mm-dd'
});

// These hold info for the charts
var scoresByDate = {};
var dateArray = [];
var timeRemainingByDate = {};
var maxTimeByDate = {};
var maxScoreByDate = {};
var combinedScoresByDate = {};
var originalDataByDate = {};

// Beta value for the combined score calculation
const BETA = 50;

// Defining the chart as global - destroy the chart should the user
// select another option to view
var combinedChartObj;

$( "#dropdown-button" ).click(function() {

    $( ".ring-spinner").show();
    $( "#dropdown-button").prop('disabled', true);

    // Check if chart exists so another chart isn't populated
    // on top of it
    if (combinedChartObj) {
        combinedChartObj.destroy()
    }

    // Reset our data objects
    scoresByDate = {};
    dateArray = [];
    timeRemainingByDate = {};
    maxTimeByDate = {};
    maxScoreByDate = {};
    combinedScoresByDate = {};
    originalDataByDate = {};

    // This is the info we want
    var lexicon = $('#lexicon').val()
    var challenge = $('#challenge').val()
    var startDate = $('#start-date').val()
    var endDate = $('#end-date').val()

    // Call the API, receive JSON
    $.ajax({
          method: "GET",
          data: {start_date: startDate, end_date: endDate},
          url: "/wordwalls/stats/api/" + lexicon + "/" + challenge + "/",
          dataType: 'json'
    })
        .done(function(msg) {

            // Parse the JSON for the info we want for the charts
            for (var i = 0; i < msg.length; i++) {
                var value = msg[i];
                var dateString = value.Date;
                var scoreShortened = (Number(value.Score) / Number(value.maxScore)) * 100;
                var timeScore = (Number(value.timeRemaining) / Number(value.maxTime)) * BETA;

                // Calculate the combined score
                var combinedScore = scoreShortened + timeScore;

                // Store all values by date
                scoresByDate[value.Date] = scoreShortened.toFixed(2);
                timeRemainingByDate[value.Date] = value.timeRemaining;
                maxTimeByDate[value.Date] = value.maxTime;
                maxScoreByDate[value.Date] = value.maxScore;
                combinedScoresByDate[value.Date] = combinedScore.toFixed(2);

                // Store original data for tooltip
                originalDataByDate[value.Date] = {
                    score: value.Score,
                    maxScore: value.maxScore,
                    timeRemaining: value.timeRemaining,
                    maxTime: value.maxTime,
                    scorePercent: scoreShortened.toFixed(2),
                    timeBonus: timeScore.toFixed(2),
                    combinedScore: combinedScore.toFixed(2)
                };

                dateArray.push(value.Date);
            }

            // Call the charts function to generate the chart on the page
            createCombinedChart();
        });

function getAverage(array, idToUpdate) {
    var count = 0;
    var total = array.length;

    for (var i = 0; i < array.length; i++) {
        num = parseFloat(array[i]);
        count += num;
    }

    var avg = (count / total).toFixed(2);
    var avgString = avg.toString();

    if (avgString === 'NaN') {
        avgString = '0';
    }

    var averageElement = $('#' + idToUpdate);
    averageElement.html(avgString);
}

function calculateRegressionLine(dates, scores) {
    // Create data points for regression [index, score]
    const dataPoints = scores.map((score, index) => [index, parseFloat(score)]);

    // Calculate the regression line
    const result = regression.linear(dataPoints);

    // Generate points for the regression line
    const regressionPoints = result.points.map(point => point[1]);

    return regressionPoints;
}

function createCombinedChart() {
    $( ".ring-spinner").hide();
    $( "#dropdown-button").prop('disabled', false);

    // Info for chart axes
    dateArray.sort();
    var scoresSorted = [];
    var timeSorted = [];
    var combinedScoresSorted = [];
    var sortedDates = [];

    for (var i = 0; i < dateArray.length; i++) {
        var date = dateArray[i];
        scoresSorted.push(scoresByDate[date]);
        timeSorted.push(timeRemainingByDate[date]);
        combinedScoresSorted.push(combinedScoresByDate[date]);
        sortedDates.push(date);
    }

    // Calculate averages
    getAverage(scoresSorted, 'scores');
    getAverage(timeSorted, 'time');
    getAverage(combinedScoresSorted, 'combined-scores');

    // Calculate regression line
    var regressionLine = calculateRegressionLine(sortedDates, combinedScoresSorted);

    // Get the canvas element
    var ctx = document.getElementById("combinedChart");

    // Create the chart
    combinedChartObj = new Chart(ctx, {
        type: 'scatter',
        data: {
            labels: sortedDates,
            datasets: [
                {
                    type: 'scatter',
                    label: 'Combined Score',
                    data: combinedScoresSorted.map((score, index) => ({
                        x: index,
                        y: parseFloat(score),
                        date: sortedDates[index]
                    })),
                    backgroundColor: 'rgba(75, 192, 192, 1)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    pointRadius: 6,
                    pointHoverRadius: 8,
                    pointBorderWidth: 2,
                    pointHoverBorderWidth: 3,
                    pointStyle: 'circle'
                },
                {
                    type: 'line',
                    label: 'Trend Line',
                    data: regressionLine.map((y, x) => ({ x, y })),
                    borderColor: 'rgba(255, 99, 132, 0.8)',
                    borderWidth: 2,
                    pointRadius: 0,
                    fill: false,
                    tension: 0
                },
                {
                    type: 'line',
                    label: 'Data Points Connection',
                    data: combinedScoresSorted.map((score, index) => ({
                        x: index,
                        y: parseFloat(score)
                    })),
                    borderColor: 'rgba(75, 192, 192, 0.3)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    tension: 0
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    ticks: {
                        callback: function(value) {
                            // Display the actual dates on x-axis
                            return sortedDates[value] || '';
                        },
                        maxRotation: 45,
                        minRotation: 45
                    },
                    title: {
                        display: true,
                        text: 'Date'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Combined Score'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            // Show date in tooltip title
                            const item = tooltipItems[0];
                            const date = sortedDates[item.parsed.x];
                            return `Date: ${date}`;
                        },
                        label: function(context) {
                            const date = sortedDates[context.parsed.x];
                            const data = originalDataByDate[date];

                            return [
                                `Combined Score: ${data.combinedScore}`,
                                `Score: ${data.score}/${data.maxScore} (${data.scorePercent}%)`,
                                `Time Bonus: ${data.timeBonus} (${data.timeRemaining}s/${data.maxTime}s)`
                            ];
                        }
                    }
                },
                legend: {
                    position: 'top',
                }
            }
        }
    });
}
});

</script>

<p class="mt-4">Stats feature originally coded by <a href="http://www.emilydowgialo.com" target="_blank">Emily Dowgialo</a>. Thanks!</p>

{% endblock %}
